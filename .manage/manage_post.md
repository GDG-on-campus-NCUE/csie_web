# Manage Post 任務分階段規劃

## 系統目標彙整
- 需支援大量文章的 CSV 匯入與匯出，以便批次建立或更新文章。
- 英文介面中與文章管理相關的欄位（Publish At、Featured Image、Upload Files 等）需正確顯示英語文案。
- 文章有「手動建立」與「引用外部連結」兩種模式，需提供對應欄位與流程。
- 透過 Tag 來區分不同的文章管理頁面或文章類型，讓後台能依 Tag 進行篩選與權限控管。
- 後台結合 Google ADK（FastAPI）與原生 API 的 AI 服務，支援翻譯、內容生成等功能，並將結果寫入資料庫。
- 系統需保有完整的 Audit Log，以流水號作為 Session Id，記錄新增、修改、刪除文章與檔案的行為。
- 前端輸入外部連結後應自動呼叫 API 取得標題、摘要等中英文資訊。

## 第一階段：CSV 批次匯入與介面多語系調整
1. **需求盤點與欄位對應表**
   - 彙整現有文章資料表欄位、Tag 關聯與檔案欄位，建立 CSV 欄位對照表。
   - 定義匯入失敗的錯誤碼與訊息（含欄位驗證、資料格式錯誤、檔案遺失）。
2. **後端匯入/匯出 API 設計**
   - 設計匯入工作排程，支援背景執行、錯誤回報與重跑機制。
   - 實作 CSV 解析、資料驗證、重複檢測（依 slug 或外部連結 URL）、Tag 綁定流程。
   - 製作匯出 API，支援篩選條件、欄位選擇、產生下載檔案。
3. **後台操作介面與狀態追蹤**
   - 新增匯入作業頁面：檔案上傳、格式說明、匯入進度條、錯誤報表下載。
   - 建立匯入紀錄列表，顯示操作人、開始時間、成功/失敗數、錯誤明細。
4. **多語系調整與翻譯資源整理**
   - 檢查英文介面下所有文章欄位，整理需翻譯字串清單。
   - 更新 i18n 資源檔，確保 Publish At、Featured Image、Upload Files 等文字在英文介面顯示正確。
   - 設定自動化測試（如 Laravel Dusk/Jest）驗證多語系切換是否顯示正確文案。

## 第二階段：文章建立模式與表單流程優化
1. **資料結構調整**
   - 為文章新增欄位標記 `type`（manual / external）與外部連結欄位（URL、來源名稱、原文語系）。
   - 若需支援引用外部內容的摘要，建立 `external_summary` 與 `external_title` 欄位。
2. **手動建立流程優化**
   - 設計分步驟表單：基本資訊（標題、摘要、Tag）、內容編輯、媒體管理。
   - 支援草稿、自動儲存、排程發佈（Publish At）。
   - 與媒體庫整合 Featured Image、Upload Files 功能，提供拖拉上傳、批次刪除。
3. **引用外部連結流程**
   - 在表單中提供模式切換（Manual / External），切換後顯示對應欄位。
   - 輸入外部 URL 後即時呼叫 Metadata API，自動填入標題、摘要、縮圖；若取得多語資訊，可提供原文與翻譯欄位。
   - 允許手動覆寫 API 回傳資料，並保留同步/更新按鈕以重新抓取外部資訊。
4. **驗證與提示**
   - 為兩種模式建立前後端驗證規則（例如 External 模式需必填 URL、Manual 模式需檢查字數上限）。
   - 完善錯誤提示、表單狀態顯示與成功訊息。

## 第三階段：Tag 控管與權限/檢索機制
1. **Tag 生命週期管理**
   - 規劃 Tag 建立、更新、停用、刪除流程，建立與文章、AI 任務的關聯表。
   - 設計 Tag 欄位的輸入介面（autocomplete、多選、顏色標示）。
2. **權限與篩選**
   - 定義角色與 Tag 的對應規則（例如某管理頁面僅能操作特定 Tag）。
   - 在文章列表與 CSV 匯入功能中加入 Tag 篩選條件，支援批次操作。
3. **檢索與報表**
   - 建立依 Tag 分類的文章統計報表、發佈排程總覽。
   - 將 Tag 細節同步至 Audit Log，方便追蹤操作範圍。

## 第四階段：AI 內容增強與翻譯流程(目前API都還不可使用，因此input中有AI產生按鈕，按下後，toast會跳出尚未開放此功能，請稍後再試)
1. **AI 服務整合架構**
   - 繪製資料流：前端輸入 → PHP 後端 → Google ADK FastAPI → 取得結果 → 寫入資料庫。
   - 定義 AI 任務類型（翻譯、摘要、延伸撰寫），設計參數格式與回傳格式。
2. **API 接口與安全控管**
   - 撰寫後端服務，封裝呼叫 Google ADK 的 SDK，支援逾時、重試、錯誤分類。
   - 以環境變數管理 API Key，記錄呼叫耗時與配額使用量。
3. **前端互動與使用限制**
   - 在文章編輯頁面新增「AI 協助」區塊，可輸入短字串請求延伸內容，並顯示字數上限提醒。
   - 支援將 AI 回傳內容插入編輯器、覆蓋欄位或另存草稿。
4. **資料庫寫入與審核流程**
   - 記錄每次 AI 呼叫的原始輸入、回傳結果、使用的 Tag、操作人員。
   - 規劃人工審核步驟：可標記 AI 結果是否採納、修改紀錄。

## 第五階段：Audit Log 與 Session 管理強化
1. **Audit Log 結構設計**
   - 以流水號作為 Session Id，記錄請求開始/結束時間、操作者、來源 IP。
   - 詳細紀錄事件類型（新增文章、更新內容、刪除、上傳檔案、刪除檔案、AI 呼叫）。
2. **寫入流程整合**
   - 在文章 CRUD、檔案上傳、AI 功能與 CSV 匯入流程中植入 Audit Log 寫入邏輯。
   - 針對批次操作（如匯入）記錄每筆成功/失敗項目，支援查詢。
3. **查詢與監控**
   - 建立後台頁面，提供依日期、操作者、Tag、事件類型的篩選與匯出。
   - 設定警示規則（如短時間內大量刪除、AI 呼叫異常）並串接通知。

## 第六階段：外部連結資訊擷取服務
1. **Metadata 擷取 API**
   - 建立服務從外部連結抓取 og:title、og:description、語言、封面圖。
   - 支援多次重試、跳過無效連結、儲存快取以減少重複呼叫。
2. **多語處理與翻譯**
   - 若外部內容非中文，提供自動翻譯選項並標記來源語系。
   - 允許手動調整翻譯內容，並將原文與翻譯一併保存供前端呈現。
3. **整合測試與驗證**
   - 撰寫單元/整合測試驗證 API 回傳格式。
   - 在前端流程中加入例外處理（如連結無法解析、需手動輸入）。

## 交付與驗收建議
- 每階段皆需提供需求文件、介面原型、資料表 migration、單元/整合測試結果、操作手冊。
- 建議於每個階段結束時進行使用者驗收測試（UAT），並彙整回饋納入下一迭代。
- 重要功能（匯入、AI 產生、Audit Log）需安排壓力測試與安全檢測，確保可在大量資料與高併發情境下運作。
